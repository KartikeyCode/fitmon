<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>S3 Bucket Media Viewer</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 30px;
        }
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f0f0;
            border-radius: 5px;
        }
        input, button, select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .media-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .media-item {
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
            background-color: white;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .media-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .media-thumbnail {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }
        video.media-thumbnail {
            background-color: #000;
        }
        .media-info {
            padding: 10px;
        }
        .media-name {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .media-size {
            color: #7f8c8d;
            font-size: 12px;
        }
        .loading {
            text-align: center;
            padding: 20px;
            font-size: 18px;
            color: #7f8c8d;
        }
        .error {
            color: #e74c3c;
            padding: 10px;
            background-color: #fadbd8;
            border-radius: 4px;
            margin-bottom: 20px;
        }
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 10px;
        }
        .no-media {
            text-align: center;
            padding: 40px;
            color: #7f8c8d;
            font-size: 16px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>S3 Bucket Media Viewer</h1>
        
        <div class="controls">
            <input type="text" id="bucketName" placeholder="Bucket Name" required>
            <input type="text" id="region" placeholder="AWS Region (e.g., us-east-1)" required>
            <input type="text" id="accessKeyId" placeholder="Access Key ID">
            <input type="text" id="secretAccessKey" placeholder="Secret Access Key">
            <input type="text" id="sessionToken" placeholder="Session Token (optional)">
            <input type="text" id="prefix" placeholder="Folder prefix (optional)">
            <select id="fileType">
                <option value="all">All Media</option>
                <option value="image">Images Only</option>
                <option value="video">Videos Only</option>
            </select>
            <button id="loadBtn">Load Media</button>
        </div>
        
        <div id="errorContainer" style="display: none;"></div>
        
        <div id="loading" class="loading" style="display: none;">Loading media...</div>
        
        <div id="mediaContainer">
            <div class="no-media">Enter your bucket details and click "Load Media" to view content</div>
        </div>
        
        <div class="pagination" id="pagination" style="display: none;">
            <button id="prevBtn">Previous</button>
            <span id="pageInfo">Page 1</span>
            <button id="nextBtn">Next</button>
        </div>
    </div>

    <script src="https://sdk.amazonaws.com/js/aws-sdk-2.0.0-rc1.min.js"></script>
    <script>
        // AWS configuration
        let s3;
        let currentPage = 1;
        const itemsPerPage = 20;
        let allMediaItems = [];
        let continuationToken = null;
        let hasMoreItems = true;
        
        // DOM elements
        const loadBtn = document.getElementById('loadBtn');
        const bucketNameInput = document.getElementById('bucketName');
        const regionInput = document.getElementById('region');
        const accessKeyIdInput = document.getElementById('accessKeyId');
        const secretAccessKeyInput = document.getElementById('secretAccessKey');
        const sessionTokenInput = document.getElementById('sessionToken');
        const prefixInput = document.getElementById('prefix');
        const fileTypeSelect = document.getElementById('fileType');
        const mediaContainer = document.getElementById('mediaContainer');
        const loadingElement = document.getElementById('loading');
        const errorContainer = document.getElementById('errorContainer');
        const paginationElement = document.getElementById('pagination');
        const prevBtn = document.getElementById('prevBtn');
        const nextBtn = document.getElementById('nextBtn');
        const pageInfo = document.getElementById('pageInfo');
        
        // Image extensions
        const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'svg'];
        // Video extensions
        const videoExtensions = ['mp4', 'webm', 'ogg', 'mov', 'avi', 'wmv', 'flv'];
        
        // Initialize AWS SDK and load media
        loadBtn.addEventListener('click', async () => {
            const bucketName = bucketNameInput.value.trim();
            const region = regionInput.value.trim();
            const accessKeyId = accessKeyIdInput.value.trim();
            const secretAccessKey = secretAccessKeyInput.value.trim();
            const sessionToken = sessionTokenInput.value.trim();
            const prefix = prefixInput.value.trim();
            const fileType = fileTypeSelect.value;
            
            if (!bucketName || !region) {
                showError('Bucket name and region are required');
                return;
            }
            
            try {
                // Configure AWS SDK
                AWS.config.update({
                    region: region,
                    ...(accessKeyId && secretAccessKey ? {
                        credentials: new AWS.Credentials({
                            accessKeyId: accessKeyId,
                            secretAccessKey: secretAccessKey,
                            ...(sessionToken ? { sessionToken: sessionToken } : {})
                        })
                    } : {})
                });
                
                s3 = new AWS.S3();
                
                // Reset state
                currentPage = 1;
                allMediaItems = [];
                continuationToken = null;
                hasMoreItems = true;
                
                // Show loading
                showLoading();
                hideError();
                mediaContainer.innerHTML = '';
                
                // Load first page
                await loadMoreMedia(bucketName, prefix, fileType);
                
                // Display first page
                displayMedia();
                
            } catch (error) {
                showError(`Error loading media: ${error.message}`);
                console.error(error);
            } finally {
                hideLoading();
            }
        });
        
        // Load more media from S3
        async function loadMoreMedia(bucketName, prefix, fileType) {
            if (!hasMoreItems) return;
            
            const params = {
                Bucket: bucketName,
                MaxKeys: 1000, // Maximum allowed by S3
                ...(prefix ? { Prefix: prefix } : {}),
                ...(continuationToken ? { ContinuationToken: continuationToken } : {})
            };
            
            const data = await s3.listObjectsV2(params).promise();
            
            // Process the items
            const newItems = data.Contents
                .filter(item => {
                    if (item.Key.endsWith('/')) return false; // Skip folders
                    
                    const extension = item.Key.split('.').pop().toLowerCase();
                    
                    if (fileType === 'image') {
                        return imageExtensions.includes(extension);
                    } else if (fileType === 'video') {
                        return videoExtensions.includes(extension);
                    }
                    return imageExtensions.includes(extension) || videoExtensions.includes(extension);
                })
                .map(item => ({
                    key: item.Key,
                    name: item.Key.split('/').pop(),
                    size: formatFileSize(item.Size),
                    lastModified: new Date(item.LastModified).toLocaleString(),
                    isImage: imageExtensions.includes(item.Key.split('.').pop().toLowerCase()),
                    isVideo: videoExtensions.includes(item.Key.split('.').pop().toLowerCase())
                }));
            
            allMediaItems = [...allMediaItems, ...newItems];
            continuationToken = data.NextContinuationToken;
            hasMoreItems = !!continuationToken;
        }
        
        // Display media in the grid
        function displayMedia() {
            if (allMediaItems.length === 0) {
                mediaContainer.innerHTML = '<div class="no-media">No media files found in the specified location</div>';
                paginationElement.style.display = 'none';
                return;
            }
            
            // Calculate pagination
            const startIdx = (currentPage - 1) * itemsPerPage;
            const endIdx = startIdx + itemsPerPage;
            const pageItems = allMediaItems.slice(startIdx, endIdx);
            
            // Create media grid
            const mediaGrid = document.createElement('div');
            mediaGrid.className = 'media-grid';
            
            pageItems.forEach(item => {
                const mediaItem = document.createElement('div');
                mediaItem.className = 'media-item';
                
                const mediaThumbnail = document.createElement(item.isImage ? 'img' : 'video');
                mediaThumbnail.className = 'media-thumbnail';
                
                // Generate a pre-signed URL for the media (valid for 1 hour)
                const url = s3.getSignedUrl('getObject', {
                    Bucket: bucketNameInput.value.trim(),
                    Key: item.key,
                    Expires: 3600
                });
                
                if (item.isImage) {
                    mediaThumbnail.src = url;
                    mediaThumbnail.alt = item.name;
                } else {
                    mediaThumbnail.src = url;
                    mediaThumbnail.controls = true;
                    mediaThumbnail.preload = "metadata";
                }
                
                const mediaInfo = document.createElement('div');
                mediaInfo.className = 'media-info';
                
                const mediaName = document.createElement('div');
                mediaName.className = 'media-name';
                mediaName.textContent = item.name;
                
                const mediaSize = document.createElement('div');
                mediaSize.className = 'media-size';
                mediaSize.textContent = `${item.size} • ${item.lastModified}`;
                
                mediaInfo.appendChild(mediaName);
                mediaInfo.appendChild(mediaSize);
                
                mediaItem.appendChild(mediaThumbnail);
                mediaItem.appendChild(mediaInfo);
                
                mediaGrid.appendChild(mediaItem);
            });
            
            mediaContainer.innerHTML = '';
            mediaContainer.appendChild(mediaGrid);
            
            // Update pagination controls
            updatePagination();
        }
        
        // Update pagination UI
        function updatePagination() {
            const totalPages = Math.ceil(allMediaItems.length / itemsPerPage);
            
            pageInfo.textContent = `Page ${currentPage} of ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages && !hasMoreItems;
            
            if (allMediaItems.length > itemsPerPage || hasMoreItems) {
                paginationElement.style.display = 'flex';
            } else {
                paginationElement.style.display = 'none';
            }
        }
        
        // Pagination event listeners
        prevBtn.addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                displayMedia();
            }
        });
        
        nextBtn.addEventListener('click', async () => {
            const totalPages = Math.ceil(allMediaItems.length / itemsPerPage);
            
            if (currentPage < totalPages) {
                currentPage++;
                displayMedia();
            } else if (hasMoreItems) {
                // Need to load more items
                try {
                    showLoading();
                    await loadMoreMedia(
                        bucketNameInput.value.trim(),
                        prefixInput.value.trim(),
                        fileTypeSelect.value
                    );
                    currentPage++;
                    displayMedia();
                } catch (error) {
                    showError(`Error loading more media: ${error.message}`);
                    console.error(error);
                } finally {
                    hideLoading();
                }
            }
        });
        
        // Helper function to format file size
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        // Helper functions for loading and error states
        function showLoading() {
            loadingElement.style.display = 'block';
            loadBtn.disabled = true;
        }
        
        function hideLoading() {
            loadingElement.style.display = 'none';
            loadBtn.disabled = false;
        }
        
        function showError(message) {
            errorContainer.style.display = 'block';
            errorContainer.innerHTML = message;
        }
        
        function hideError() {
            errorContainer.style.display = 'none';
            errorContainer.innerHTML = '';
        }
    </script>
</body>
</html>